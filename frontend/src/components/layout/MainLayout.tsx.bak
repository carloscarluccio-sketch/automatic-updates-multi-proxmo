import React, { useState } from 'react';
import { Outlet, useNavigate, useLocation } from 'react-router-dom';
import {
  AppBar,
  Box,
  Button,
  Toolbar,
  Typography,
  Drawer,
  List,
  ListItem,
  ListItemButton,
  ListItemIcon,
  ListItemText,
  Collapse,
} from '@mui/material';
import DashboardIcon from '@mui/icons-material/Dashboard';
import ComputerIcon from '@mui/icons-material/Computer';
import BusinessIcon from '@mui/icons-material/Business';
import GroupIcon from '@mui/icons-material/Group';
import StorageIcon from '@mui/icons-material/Storage';
import FolderIcon from '@mui/icons-material/Folder';
import NetworkCheckIcon from '@mui/icons-material/NetworkCheck';
import BarChartIcon from '@mui/icons-material/BarChart';
import AssessmentIcon from '@mui/icons-material/Assessment';
import FeedbackIcon from '@mui/icons-material/Feedback';
import HelpOutlineIcon from '@mui/icons-material/HelpOutline';
import ArticleIcon from '@mui/icons-material/Article';
import SupportAgentIcon from '@mui/icons-material/SupportAgent';
import WebhookIcon from '@mui/icons-material/Webhook';
import CardMembershipIcon from '@mui/icons-material/CardMembership';
import SecurityIcon from '@mui/icons-material/Security';
import SettingsIcon from '@mui/icons-material/Settings';
import CloudIcon from '@mui/icons-material/Cloud';
import PaletteIcon from '@mui/icons-material/Palette';
import EmailIcon from '@mui/icons-material/Email';
import VpnKeyIcon from '@mui/icons-material/VpnKey';
import ShieldIcon from '@mui/icons-material/Shield';
import HistoryIcon from '@mui/icons-material/History';
import ExpandLess from '@mui/icons-material/ExpandLess';
import ExpandMore from '@mui/icons-material/ExpandMore';
import CloudDownloadIcon from '@mui/icons-material/CloudDownload';
import AttachMoneyIcon from '@mui/icons-material/AttachMoney';
import PriceChangeIcon from '@mui/icons-material/PriceChange';
import BackupIcon from '@mui/icons-material/Backup';
import ScheduleIcon from '@mui/icons-material/Schedule';
import CameraAltIcon from '@mui/icons-material/CameraAlt';
import ReceiptIcon from '@mui/icons-material/Receipt';
import TrendingUpIcon from '@mui/icons-material/TrendingUp';
import SyncIcon from '@mui/icons-material/Sync';
import PlaylistAddCheckIcon from '@mui/icons-material/PlaylistAddCheck';
import DescriptionIcon from '@mui/icons-material/Description';
import BookmarkIcon from '@mui/icons-material/Bookmark';
import TimelineIcon from '@mui/icons-material/Timeline';
import SpeedIcon from '@mui/icons-material/Speed';
import CloudSyncIcon from '@mui/icons-material/CloudSync';
import NotificationsIcon from '@mui/icons-material/Notifications';
import MonitorIcon from '@mui/icons-material/Monitor';
import AlarmIcon from '@mui/icons-material/Alarm';
import { useAuthStore } from '../../store/authStore';
import { authService } from '../../services/authService';
import { useBranding } from '../../theme/DynamicThemeProvider';
import { GlobalSearchBar } from '../GlobalSearchBar';

const drawerWidth = 260;

interface MenuItem {
  label: string;
  path?: string;
  icon: React.ReactElement;
  children?: MenuItem[];
  roles?: string[];
}

export const MainLayout: React.FC = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const logout = useAuthStore((state) => state.logout);
  const user = useAuthStore((state) => state.user);
  const { branding } = useBranding();

  const [openSections, setOpenSections] = useState<{ [key: string]: boolean }>({
    infrastructure: true,
    network: true,
    security: true,
    monitoring: true,
    administration: true,
    system: true,
    infrastructure: true,
    security: false,
    administration: true,
    monitoring: false,
    system: false,
  });

  const handleLogout = async () => {
    await authService.logout();
    logout();
    navigate('/login');
  };

  const isActive = (path: string) => location.pathname === path;

  const toggleSection = (section: string) => {
    setOpenSections((prev) => ({ ...prev, [section]: !prev[section] }));
  };

  const menuStructure: MenuItem[] = [
    { label: 'Dashboard', path: '/dashboard', icon: <DashboardIcon /> },
    { label: 'Analytics', path: '/analytics', icon: <BarChartIcon /> },
    { label: 'Billing', path: '/billing', icon: <AttachMoneyIcon /> },
    { label: 'Invoices', path: '/invoices', icon: <ReceiptIcon /> },
    { label: 'Usage Dashboard', path: '/usage-dashboard', icon: <TrendingUpIcon /> },
    ...(user?.role === 'super_admin' ? [{ label: 'Pricing Management', path: '/pricing-plans', icon: <PriceChangeIcon /> }] : []),
    {
      label: 'Infrastructure',
      icon: <CloudIcon />,
      children: [
        { label: 'Virtual Machines', path: '/vms', icon: <ComputerIcon /> },
        { label: 'Clusters', path: '/clusters', icon: <StorageIcon /> },
        { label: 'Projects', path: '/projects', icon: <FolderIcon /> },
        { label: 'Templates', path: '/templates', icon: <AssessmentIcon /> },
        { label: 'ISOs', path: '/isos', icon: <AssessmentIcon /> },
        { label: 'VM Import & Discovery', path: '/vm-import', icon: <CloudDownloadIcon /> },
        { label: 'ESXi Import', path: '/esxi-import', icon: <CloudSyncIcon /> },
        { label: 'VM Templates', path: '/vm-templates', icon: <DescriptionIcon /> },
        { label: 'Backup Policies', path: '/backup-policies', icon: <BackupIcon /> },
        { label: 'Backup Schedules', path: '/backup-schedules', icon: <ScheduleIcon /> },
        { label: 'Snapshot Schedules', path: '/snapshot-schedules', icon: <CameraAltIcon /> },
        { label: 'DR Cluster Pairs', path: '/dr-cluster-pairs', icon: <SyncIcon /> },
        { label: 'DR Test Schedules', path: '/dr-test-schedules', icon: <PlaylistAddCheckIcon /> },
      ],
    },
    {
      label: 'Network',
      icon: <NetworkCheckIcon />,
      children: [
        { label: 'IP Ranges', path: '/ip-ranges', icon: <NetworkCheckIcon /> },
        { label: 'IP Reservations', path: '/ip-reservations', icon: <BookmarkIcon /> },
        { label: 'IP Tracking', path: '/ip-tracking', icon: <TimelineIcon /> },
        { label: 'NAT Rules', path: '/nat', icon: <NetworkCheckIcon /> },
        { label: 'NAT Performance', path: '/nat-performance', icon: <SpeedIcon /> },
      ],
    },
    {
      label: 'Security',
      icon: <SecurityIcon />,
      children: [
        { label: 'OPNsense Firewalls', path: '/opnsense', icon: <SecurityIcon /> },
        { label: 'SSO Configuration', path: '/sso', icon: <ShieldIcon /> },
        { label: '2FA Settings', path: '/2fa', icon: <VpnKeyIcon /> },
        { label: 'API Tokens', path: '/api-tokens', icon: <VpnKeyIcon /> },
        { label: 'API Documentation', path: '/api-docs', icon: <DescriptionIcon /> },
      ],
    },
    {
      label: 'Monitoring',
      icon: <MonitorIcon />,
      children: [
        { label: 'Monitoring Dashboard', path: '/monitoring', icon: <MonitorIcon /> },
        { label: 'Alert Rules', path: '/alert-rules', icon: <AlarmIcon /> },
        { label: 'Notifications', path: '/notifications', icon: <NotificationsIcon /> },
      ],
    },
    {
      label: 'Administration',
      icon: <SettingsIcon />,
      children: [
        { label: 'Companies', path: '/companies', icon: <BusinessIcon /> },
        { label: 'Users', path: '/users', icon: <GroupIcon /> },
        { label: 'Profiles', path: '/profiles', icon: <AssessmentIcon /> },
        { label: 'Branding', path: '/branding', icon: <PaletteIcon /> },
        { label: 'Email Templates', path: '/email-templates', icon: <EmailIcon /> },
      ],
    },
    {
      label: 'System',
      icon: <HistoryIcon />,
      children: [
        { label: 'Activity Logs', path: '/activity-logs', icon: <HistoryIcon /> },
        { label: 'Webhooks', path: '/webhooks', icon: <WebhookIcon /> },
        { label: 'Subscriptions', path: '/subscriptions', icon: <CardMembershipIcon /> },
        { label: 'Rate Limits', path: '/rate-limits', icon: <SpeedIcon /> },
        { label: 'Notification Settings', path: '/notification-settings', icon: <NotificationsIcon /> },
        { label: 'Support Tickets', path: '/support-tickets', icon: <SupportAgentIcon /> },
        { label: 'Help Center', path: '/help', icon: <HelpOutlineIcon /> },
        { label: 'Knowledge Base Admin', path: '/help-admin/articles', icon: <ArticleIcon />, roles: ['super_admin', 'company_admin'] },
        { label: 'Feedback', path: '/feedback', icon: <FeedbackIcon /> },
      ],
    },
  ];

  const renderMenuItem = (item: MenuItem) => {
    if (item.children) {
      const sectionKey = item.label.toLowerCase().replace(/\s+/g, '');
      const isOpen = openSections[sectionKey] ?? false;

      return (
        <React.Fragment key={item.label}>
          <ListItem disablePadding>
            <ListItemButton onClick={() => toggleSection(sectionKey)}>
              <ListItemIcon>{item.icon}</ListItemIcon>
              <ListItemText primary={item.label} />
              {isOpen ? <ExpandLess /> : <ExpandMore />}
            </ListItemButton>
          </ListItem>
          <Collapse in={isOpen} timeout="auto" unmountOnExit>
            <List component="div" disablePadding>
              {item.children.map((child) => (
                <ListItem key={child.path} disablePadding>
                  <ListItemButton
                    sx={{ pl: 4 }}
                    selected={child.path ? isActive(child.path) : false}
                    onClick={() => child.path && navigate(child.path)}
                  >
                    <ListItemIcon>{child.icon}</ListItemIcon>
                    <ListItemText primary={child.label} />
                  </ListItemButton>
                </ListItem>
              ))}
            </List>
          </Collapse>
        </React.Fragment>
      );
    }

    return (
      <ListItem key={item.path} disablePadding>
        <ListItemButton
          selected={item.path ? isActive(item.path) : false}
          onClick={() => item.path && navigate(item.path)}
        >
          <ListItemIcon>{item.icon}</ListItemIcon>
          <ListItemText primary={item.label} />
        </ListItemButton>
      </ListItem>
    );
  };

  return (
    <Box sx={{ display: 'flex' }}>
      <AppBar position="fixed" sx={{ zIndex: (theme) => theme.zIndex.drawer + 1 }}>
        <Toolbar>
          <Box sx={{ display: 'flex', alignItems: 'center', flexGrow: 1 }}>
            {branding?.logo_filename && (
              <img
                src={`/uploads/logos/${branding.logo_filename}`}
                alt="Logo"
                style={{ height: 40, marginRight: 12 }}
              />
            )}
            <Typography variant="h6">
              {branding?.panel_name || 'Proxmox Multi-Tenant'}
            </Typography>
          </Box>
          <Box sx={{ flexGrow: 1, display: 'flex', justifyContent: 'center', maxWidth: 600, mx: 2 }}>
            <GlobalSearchBar />
          </Box>
          {user && (
            <Typography variant="body2" sx={{ mr: 2 }}>
              {user.email} ({user.role})
            </Typography>
          )}
          <Button color="inherit" onClick={handleLogout}>
            Logout
          </Button>
        </Toolbar>
      </AppBar>

      <Drawer
        variant="permanent"
        sx={{
          width: drawerWidth,
          flexShrink: 0,
          '& .MuiDrawer-paper': {
            width: drawerWidth,
            boxSizing: 'border-box',
          },
        }}
      >
        <Toolbar />
        <Box sx={{ overflow: 'auto' }}>
          <List>
            {menuStructure.map((item) => renderMenuItem(item))}
          </List>
        </Box>
      </Drawer>

      <Box component="main" sx={{ flexGrow: 1, p: 3 }}>
        <Toolbar />
        <Outlet />
      </Box>
    </Box>
  );
};
